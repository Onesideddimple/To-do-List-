<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List with Persistent Reminders</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8 px-4">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">To-Do List</h1>

        <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <input
                type="text"
                id="todo-input"
                placeholder="Add a new task..."
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <button
                onclick="addTask()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
            >
                Add Task
            </button>
        </div>

        <ul id="todo-list" class="space-y-4">
            <!-- To-Do items will be rendered here -->
        </ul>
    </div>

    <!-- Custom Modal for Alerts and Prompts -->
    <div id="custom-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-message" class="text-lg text-gray-700 mb-4"></p>
            <input
                type="number"
                id="modal-input"
                placeholder="Minutes"
                class="w-full p-2 border border-gray-300 rounded-lg mb-4 hidden focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <div class="flex justify-center gap-4">
                <button
                    id="modal-ok-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                >
                    OK
                </button>
                <button
                    id="modal-cancel-btn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-5 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 hidden"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Modal Control Functions ---
        let currentModalCallback = null;

        /**
         * Displays a custom alert modal.
         * @param {string} message - The message to display.
         */
        function showAlertModal(message) {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalInput = document.getElementById('modal-input');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalMessage.textContent = message;
            modalInput.classList.add('hidden'); // Hide input for alerts
            cancelBtn.classList.add('hidden'); // Hide cancel for alerts

            okBtn.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        }

        /**
         * Displays a custom prompt modal.
         * @param {string} message - The message to display.
         * @param {function} callback - Callback function to execute with the input value.
         */
        function showPromptModal(message, callback) {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalInput = document.getElementById('modal-input');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalMessage.textContent = message;
            modalInput.value = ''; // Clear previous input
            modalInput.classList.remove('hidden'); // Show input for prompts
            cancelBtn.classList.remove('hidden'); // Show cancel for prompts

            currentModalCallback = callback; // Store the callback

            okBtn.onclick = () => {
                modal.classList.add('hidden');
                if (currentModalCallback) {
                    currentModalCallback(modalInput.value);
                    currentModalCallback = null; // Clear callback after use
                }
            };

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                if (currentModalCallback) {
                    currentModalCallback(null); // Pass null if cancelled
                    currentModalCallback = null; // Clear callback after use
                }
            };

            modal.classList.remove('hidden');
            modalInput.focus(); // Focus on the input field
        }

        // --- To-Do List Core Functions ---

        /**
         * Adds a new task to the list and saves it to local storage.
         */
        function addTask() {
            const input = document.getElementById('todo-input');
            const taskText = input.value.trim();

            if (taskText === "") {
                showAlertModal("Task cannot be empty!");
                return;
            }

            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            // Each task now includes a reminderTime (timestamp) and reminderFired status
            tasks.push({ text: taskText, reminderTime: null, reminderFired: false });
            localStorage.setItem('tasks', JSON.stringify(tasks));
            input.value = ''; // Clear input field
            renderTasks();
        }

        /**
         * Renders all tasks from local storage to the UI.
         */
        function renderTasks() {
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            const list = document.getElementById('todo-list');
            list.innerHTML = ''; // Clear existing list items

            if (tasks.length === 0) {
                list.innerHTML = '<li class="text-center text-gray-500">No tasks yet. Add one above!</li>';
                return;
            }

            tasks.forEach((task, i) => {
                // Determine reminder status text
                let reminderStatus = '';
                if (task.reminderTime) {
                    const reminderDate = new Date(task.reminderTime);
                    if (reminderDate > new Date()) {
                        reminderStatus = `<span class="text-sm text-blue-600 ml-2">(Reminder: ${reminderDate.toLocaleString()})</span>`;
                    } else if (task.reminderFired) {
                        reminderStatus = `<span class="text-sm text-green-600 ml-2">(Reminder Fired)</span>`;
                    } else {
                        reminderStatus = `<span class="text-sm text-red-600 ml-2">(Reminder Missed/Expired)</span>`;
                    }
                }

                list.innerHTML += `
                    <li class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <span class="text-gray-800 font-medium break-words w-full sm:w-auto flex-grow mr-2">
                            ${task.text}
                            ${reminderStatus}
                        </span>
                        <div class="flex flex-wrap gap-2 mt-3 sm:mt-0 sm:ml-4">
                            <button
                                onclick="deleteTask(${i})"
                                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75"
                            >
                                Delete
                            </button>
                            <button
                                onclick="setReminderPrompt(${i})"
                                class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                            >
                                Set Reminder
                            </button>
                        </div>
                    </li>
                `;
            });
        }

        /**
         * Deletes a task from the list and local storage.
         * @param {number} index - The index of the task to delete.
         */
        function deleteTask(index) {
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            tasks.splice(index, 1); // Remove the task at the given index
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks(); // Re-render the list
        }

        // --- Reminder Functions (Browser Notifications) ---

        /**
         * Prompts the user for reminder minutes using the custom modal.
         * @param {number} index - The index of the task to set a reminder for.
         */
        function setReminderPrompt(index) {
            showPromptModal("Remind me in how many minutes?", (minutes) => {
                if (minutes === null) { // User clicked Cancel
                    return;
                }
                minutes = parseInt(minutes, 10);
                if (isNaN(minutes) || minutes <= 0) {
                    showAlertModal("Please enter a valid positive number for minutes.");
                    return;
                }
                setReminder(index, minutes);
            });
        }

        /**
         * Sets a browser notification reminder for a specific task.
         * Persists reminder data and re-schedules on page load.
         * @param {number} index - The index of the task.
         * @param {number} minutes - The number of minutes until the reminder.
         * @param {boolean} [isReschedule=false] - True if this is being called from reschedulePersistedReminders.
         */
        function setReminder(index, minutes, isReschedule = false) {
            // Request notification permission if not already granted
            Notification.requestPermission().then(permission => {
                if (permission !== 'granted') {
                    showAlertModal('Notification permission denied. Please allow notifications in your browser settings.');
                    return;
                }

                let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                let task = tasks[index];

                if (!task) {
                    console.error("Task not found for reminder:", index);
                    return;
                }

                const reminderTime = Date.now() + minutes * 60 * 1000; // Calculate future timestamp

                // Update task in local storage with reminder details
                task.reminderTime = reminderTime;
                task.reminderFired = false; // Reset fired status if re-setting reminder
                localStorage.setItem('tasks', JSON.stringify(tasks));

                // Schedule the browser notification
                setTimeout(() => {
                    new Notification('To-Do Reminder', {
                        body: task.text,
                        icon: 'https://placehold.co/64x64/000000/FFFFFF?text=TODO' // Placeholder icon
                    });

                    // Mark reminder as fired in local storage
                    let updatedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                    if (updatedTasks[index]) {
                        updatedTasks[index].reminderFired = true;
                        localStorage.setItem('tasks', JSON.stringify(updatedTasks));
                        renderTasks(); // Re-render to update status
                    }
                }, minutes * 60000);

                if (!isReschedule) {
                    showAlertModal(`Reminder set for "${task.text}" in ${minutes} minutes!`);
                }
                renderTasks(); // Re-render to show updated reminder status immediately
            });
        }

        /**
         * Checks local storage for any pending reminders and re-schedules them.
         * This function runs on page load.
         */
        function reschedulePersistedReminders() {
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            const currentTime = Date.now();

            tasks.forEach((task, index) => {
                if (task.reminderTime && !task.reminderFired) {
                    const timeRemaining = task.reminderTime - currentTime;
                    if (timeRemaining > 1000) { // Only reschedule if more than 1 second remaining
                        const minutesRemaining = Math.ceil(timeRemaining / (60 * 1000));
                        console.log(`Rescheduling reminder for "${task.text}" in ${minutesRemaining} minutes.`);
                        setReminder(index, minutesRemaining, true); // Pass true for isReschedule
                    } else if (timeRemaining <= 1000 && timeRemaining > -60000) { // If reminder should have fired recently (within last minute)
                        // Fire it immediately if it was just missed
                        new Notification('To-Do Reminder (Missed)', {
                            body: task.text + " (This reminder was set earlier and is now due)",
                            icon: 'https://placehold.co/64x64/000000/FFFFFF?text=TODO'
                        });
                        // Mark as fired
                        task.reminderFired = true;
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                    } else if (timeRemaining <= -60000) { // If reminder is significantly past due
                        // Mark as fired/expired without sending notification
                        task.reminderFired = true;
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                    }
                }
            });
            renderTasks(); // Ensure UI reflects any changes after rescheduling
        }

        // --- Initialize on Page Load ---
        window.onload = () => {
            renderTasks(); // Render existing tasks first
            reschedulePersistedReminders(); // Then reschedule any pending reminders
        };
    </script>
</body>
  </html>
